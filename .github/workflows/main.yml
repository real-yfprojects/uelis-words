name: Transcribe

on: workflow_dispatch

jobs:
    install-whisper:
        name: Install whisper
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v2
            - name: Cache whisper.cpp
              id: cache-whispercpp
              uses: actions/cache@v3
              with:
                  path: whisper.cpp
                  key: whisper.cpp
            - name: Download if not cached
              id: download-whispercpp
              if: steps.cache-whispercpp.outputs.cache-hit != 'true'
              run: bash setup.sh
            - name: Upload whisper.cpp
              uses: actions/upload-artifact@master
              with:
                  name: whisper.cpp
                  path: whisper.cpp
    transcribe:
        name: Transcribe
        runs-on: ubuntu-latest
        needs: install-whisper
        steps:
            - uses: actions/checkout@v2
            - name: Download whisper.cpp
              uses: actions/download-artifact@master
              with:
                  name: whisper.cpp
                  path: whisper.cpp
            - uses: FedericoCarboni/setup-ffmpeg@v2
            - run: bash setup.sh
            - name: Setup | Rust
              uses: ATiltedTree/setup-rust@v1
              with:
                  rust-version: nightly
            - run: cargo run --release
              env:
                  USERNAME: ${{ secrets.USERNAME }}
                  PASSWORD: ${{ secrets.PASSWORD }}
            # - run: bash transcribe.sh
            - run: git add transcribed.txt output
            - run: git config --global user.email "github-actions[bot]@users.noreply.github.com"
            - run: git config --global user.name "github-actions[bot]"
            - run: git commit -m "Transcribe"
            - run: git push
